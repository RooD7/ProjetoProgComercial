unit Unit_Vendas;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.Buttons, Vcl.Grids,
  Vcl.ExtCtrls, Unit_Persistencia;

type
  TfrmVendas = class(TForm)
    GroupBox1: TGroupBox;
    GroupBox2: TGroupBox;
    edt_CodVenda: TLabeledEdit;
    edt_DataVenda: TLabeledEdit;
    Panel3: TPanel;
    Panel1: TPanel;
    sgd_Produtos: TStringGrid;
    edt_CodProduto: TLabeledEdit;
    edt_DescProduto: TLabeledEdit;
    edt_PrecoProduto: TLabeledEdit;
    edt_Qtde: TLabeledEdit;
    btn_InserirProduto: TBitBtn;
    btn_RemoverProduto: TBitBtn;
    edt_Total: TLabeledEdit;
    Panel2: TPanel;
    btn_Editar: TBitBtn;
    btn_Limpar: TBitBtn;
    btn_Cancelar: TBitBtn;
    btn_Gravar: TBitBtn;
    btn_Sair1: TBitBtn;

    Procedure Pinta_Grid;
    Function Coleta_Produtos : Produtos_Venda;
    procedure Habilita_Tela(Habilita : Boolean);
    procedure Habilita_Botoes(Quais : String);
    procedure Limpa_Tela;


    procedure btn_EditarClick(Sender: TObject);
    procedure btn_LimparClick(Sender: TObject);
    procedure btn_CancelarClick(Sender: TObject);
    procedure btn_GravarClick(Sender: TObject);
    procedure btn_Sair1Click(Sender: TObject);
    procedure edt_CodProdutoChange(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  frmVendas: TfrmVendas;

implementation

{$R *.dfm}


Procedure TfrmVendas.Pinta_Grid;
  Begin
sgd_Produtos.Cells[0,0] := 'Cód.';
sgd_Produtos.Cells[1,0] := 'Descrição';
sgd_Produtos.Cells[2,0] := 'Preço';
sgd_Produtos.Cells[3,0] := 'Qtde';
sgd_Produtos.Cells[4,0] := 'Total';
sgd_Produtos.ColWidths[0] := 60;
sgd_Produtos.ColWidths[1] := 100;
sgd_Produtos.ColWidths[2] := 100;
sgd_Produtos.ColWidths[3] := 80;
sgd_Produtos.ColWidths[4] := 80;
  End;

Function TfrmVendas.Coleta_Produtos : Produtos_Venda;
  Var
    I : Integer;
  Begin
    SetLength(Result,sgd_Produtos.RowCount-1);
    for I := 1 to sgd_Produtos.RowCount do
      Begin
        Result[I-1].Codigo := StrToInt(sgd_Produtos.Cells[0,I]);
        Result[I-1].Preco_Venda := StrToFloat(sgd_Produtos.Cells[2,I]);
        Result[I-1].Qtde := StrToFloat(sgd_Produtos.Cells[3,I]);
      End;
  End;

procedure TfrmVendas.edt_CodProdutoChange(Sender: TObject);
Var
  Produto_Temp : Dados_Produto;
begin
  Produto_Temp := Retorna_Dados_Produto(StrToInt(edt_CodProduto.Text));
  if Produto_Temp.Codigo <> -1
    then Begin
           edt_DescProduto.Text := Produto_Temp.Descricao;
           edt_PrecoProduto.Text := FloatToStr(Produto_Temp.Preco_Venda);
         End
    Else Begin
           edt_DescProduto.Clear;
           edt_PrecoProduto.Clear;
         End;
end;

procedure TfrmVendas.Habilita_Tela(Habilita : Boolean);
  Begin
    edt_CodVenda.Enabled := Habilita;
    edt_DataVenda.Enabled := Habilita;
    edt_CodProduto.Enabled := Habilita;
    edt_DescProduto.Enabled := Habilita;
    edt_PrecoProduto.Enabled := Habilita;
    edt_Qtde.Enabled := Habilita;
    sgd_Produtos.Enabled := Habilita;
    edt_Total.Enabled := Habilita;
    btn_InserirProduto.Enabled := Habilita;
    btn_RemoverProduto.Enabled := Habilita;
  End;

procedure TfrmVendas.Limpa_Tela;
  Begin
    edt_CodVenda.Clear;
    edt_DataVenda.Clear;
    edt_CodProduto.Clear;
    edt_DescProduto.Clear;
    edt_PrecoProduto.Clear;
    edt_Qtde.Clear;
    edt_Total.Clear;
  End;

procedure TfrmVendas.Habilita_Botoes(Quais : String);
  Begin
    if Quais[1] = '0'
      then btn_Editar.Enabled := False
      Else btn_Editar.Enabled := True;
    if Quais[2] = '0'
      then btn_Limpar.Enabled := False
      Else btn_Limpar.Enabled := True;
    if Quais[3] = '0'
      then btn_Cancelar.Enabled := False
      Else btn_Cancelar.Enabled := True;
    if Quais[4] = '0'
      then btn_Gravar.Enabled := False
      Else btn_Gravar.Enabled := True;
    if Quais[5] = '0'
      then btn_Sair1.Enabled := False
      Else btn_Sair1.Enabled := True;
  End;

procedure TfrmVendas.btn_CancelarClick(Sender: TObject);
begin
    Habilita_Botoes('10001');
    Habilita_Tela(False);
    Limpa_Tela;
end;

procedure TfrmVendas.btn_EditarClick(Sender: TObject);
begin
    Habilita_Tela(True);
    Habilita_Botoes('01110');
    edt_CodVenda.Text := Retorna_Proximo_Codigo_Venda;
end;

procedure TfrmVendas.btn_GravarClick(Sender: TObject);
Var
  Prods : Produtos_Venda;
Begin
  Prods := Coleta_Produtos;
  Grava_Dados_Venda(edt_CodVenda.Text,edt_DataVenda.Text,StrToFloat(edt_Total.Text),Prods);
  Habilita_Tela(False);
  Habilita_Botoes('10001');
End;

procedure TfrmVendas.btn_LimparClick(Sender: TObject);
  Begin
  if Application.MessageBox('Deseja realmente limpar todos os campos? Tem Certeza?',
                            'Limpar todos os campos?',
                            MB_ICONQUESTION+MB_YESNO) = mrYes
   then Limpa_Tela;
  End;

procedure TfrmVendas.btn_Sair1Click(Sender: TObject);
begin
    frmVendas.Close;
end;

end.
